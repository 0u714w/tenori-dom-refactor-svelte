import{visit as e}from"graphql/language/visitor.mjs";import{Kind as t}from"graphql/language/kinds.mjs";import{print as n}from"graphql/language/printer.mjs";import{k as r,_ as i,s as o,C as u,m as s,a as c,b as p,c as l,d as y,e as d,f as v}from"./d38b1732.min.mjs";export{C as CombinedError,f as createRequest,h as getOperationName,a as makeErrorResult,m as makeResult,g as stringifyVariables}from"./d38b1732.min.mjs";import{toPromise as k,take as q,share as x,filter as w,map as O,tap as b,merge as E,mergeMap as _,takeUntil as P,make as S,onPush as M,makeSubject as R,subscribe as j,publish as A,onStart as D,onEnd as Q,switchMap as L,fromValue as N}from"wonka";function T(e,t){if(Array.isArray(e))for(var n=0;n<e.length;n++)T(e[n],t);else if("object"==typeof e&&null!==e)for(var r in e)"__typename"===r&&"string"==typeof e[r]?t[e[r]]=0:T(e[r],t);return t}function $(e){return Object.keys(T(e,{}))}var F=function(e){if(e.selectionSet&&!e.selectionSet.selections.some((function(e){return e.kind===t.FIELD&&"__typename"===e.name.value&&!e.alias})))return i({},e,{selectionSet:i({},e.selectionSet,{selections:e.selectionSet.selections.concat([{kind:t.FIELD,name:{kind:t.NAME,value:"__typename"}}])})})},I=new Map;function G(t){var n=r(t),i=I.get(n.__key);return i||((i=e(n,{Field:F,InlineFragment:F})).__key=n.__key,I.set(n.__key,i)),i}function J(e){return e&&"object"==typeof e?Object.keys(e).reduce((function(t,n){var r=e[n];return"__typename"===n?Object.defineProperty(t,"__typename",{enumerable:!1,value:r}):t[n]=Array.isArray(r)?r.map(J):r&&"object"==typeof r&&"__typename"in r?J(r):r,t}),{}):e}function U(e){return e.toPromise=function(){return k(q(1)(e))},e}function V(e,t,n){return n||(n=t.context),{key:t.key,query:t.query,variables:t.variables,kind:e,context:n}}function z(e,t){return V(e.kind,e,i({},e.context,{meta:i({},e.context.meta,t)}))}function B(){}function H(e,n,r){for(var i=0;i<r.length;i++)if(r[i].kind===t.FRAGMENT_DEFINITION){var u=r[i].name.value,a=o(r[i]);e.has(u)||(e.set(u,a),n.push(r[i]))}else n.push(r[i])}function K(){for(var e=arguments,n=new Map,i=[],o=[],u=Array.isArray(arguments[0])?arguments[0][0]:arguments[0]||"",a=1;a<arguments.length;a++){var s=e[a];s&&s.definitions?o.push.apply(o,s.definitions):u+=s,u+=e[0][a]}return H(n,i,r(u).definitions),H(n,i,o),r({kind:t.DOCUMENT,definitions:i})}function W(e){var t=e.kind;return"subscription"!==t&&"query"!==t}function X(e){var t={},n=[];function r(e){n.push(e.operation.key),1===n.length&&Promise.resolve().then((function(){for(var e;e=n.shift();)delete t[e]}))}function o(e){return!W(e)&&void 0!==t[e.key]}var a=function(n){var i=n.client,a=n.forward;return function(n){var s=e&&"boolean"==typeof e.isClient?!!e.isClient:!i.suspense,c=x(n),f=a(w((function(e){return!o(e)}))(c)),p=O((function(e){var n,r,i;return r=(n=t[e.key]).error,{operation:e,data:(i=n.data)?JSON.parse(i):void 0,extensions:void 0,error:r?new u({networkError:r.networkError?new Error(r.networkError):void 0,graphQLErrors:r.graphQLErrors&&r.graphQLErrors.length?r.graphQLErrors:void 0}):void 0}}))(w((function(e){return o(e)}))(c));return s?p=b(r)(p):f=b((function(e){var n=e.operation;if(!W(n)){var r=function(e){var t=e.data,n=e.error,r={};return void 0!==t&&(r.data=JSON.stringify(t)),n&&(r.error={graphQLErrors:n.graphQLErrors.map((function(e){return e.path||e.extensions?{message:e.message,path:e.path,extensions:e.extensions}:e.message}))},n.networkError&&(r.error.networkError=""+n.networkError)),r}(e);t[n.key]=r}}))(f),E([f,p])}};return a.restoreData=function(e){return i(t,e)},a.extractData=function(){return i({},t)},e&&e.initialState&&a.restoreData(e.initialState),a}function Y(e){var t=e.kind;return"mutation"!==t&&"query"!==t}function Z(e){var t=e.forward,n=e.client,r=new Map,o=Object.create(null);function u(e){var t=V(e.kind,e);return t.query=G(e.query),t}function a(e){var t=e.context.requestPolicy;return"query"===e.kind&&"network-only"!==t&&("cache-only"===t||r.has(e.key))}return function(e){var s=x(e),c=O((function(e){var t=r.get(e.key),o=i({},t,{operation:z(e,{cacheOutcome:t?"hit":"miss"})});return"cache-and-network"===e.context.requestPolicy&&(o.stale=!0,ee(n,e)),o}))(w((function(e){return!Y(e)&&a(e)}))(s)),f=b((function(e){var t=e.operation;if(t){var i=$(e.data).concat(t.context.additionalTypenames||[]);if("mutation"===e.operation.kind){for(var u=new Set,a=0;a<i.length;a++){var s=i[a],c=o[s]||(o[s]=new Set);c.forEach((function(e){u.add(e)})),c.clear()}u.forEach((function(e){r.has(e)&&(t=r.get(e).operation,r.delete(e),ee(n,t))}))}else if("query"===t.kind&&e.data){r.set(t.key,e);for(var f=0;f<i.length;f++){var p=i[f];(o[p]||(o[p]=new Set)).add(t.key)}}}}))(t(w((function(e){return"query"!==e.kind||"cache-only"!==e.context.requestPolicy}))(O((function(e){return z(e,{cacheOutcome:"miss"})}))(E([O(u)(w((function(e){return!Y(e)&&!a(e)}))(s)),w((function(e){return Y(e)}))(s)])))));return E([c,f])}}function ee(e,t){return e.reexecuteOperation(V(t.kind,t,i({},t.context,{requestPolicy:"network-only"})))}function te(e){var t=e.forwardSubscription,r=e.enableAllOperations;return function(e){var o=e.client,u=e.forward;function a(e){var t=e.kind;return"subscription"===t||!!r&&("query"===t||"mutation"===t)}return function(e){var r=x(e),f=_((function(e){var u=e.key,a=w((function(e){return"teardown"===e.kind&&e.key===u}))(r);return P(a)(function(e){var r=t({key:e.key.toString(36),query:n(e.query),variables:e.variables,context:i({},e.context)});return S((function(t){var n,i=t.next,u=t.complete,a=!1;return Promise.resolve().then((function(){a||(n=r.subscribe({next:function(t){return i(s(e,t))},error:function(t){return i(c(e,t))},complete:function(){a||(a=!0,"subscription"===e.kind&&o.reexecuteOperation(V("teardown",e,e.context)),u())}}))})),function(){a=!0,n&&n.unsubscribe()}}))}(e))}))(w(a)(r)),p=u(w((function(e){return!a(e)}))(r));return E([f,p])}}}function ne(e){var t=e.forward;return function(e){return t(e)}}function re(e){var t=e.forward,n=new Set;function r(e){var t=e.key,r=e.kind;if("teardown"===r)return n.delete(t),!0;if("query"!==r&&"subscription"!==r)return!0;var i=n.has(t);return n.add(t),!i}function i(e){n.delete(e.operation.key)}return function(e){var n=w(r)(e);return b(i)(t(n))}}function ie(e){var t=e.forward;return function(e){var n=x(e),r=_((function(e){var t=e.key,r=w((function(e){return"teardown"===e.kind&&e.key===t}))(n),i=p(e),o=l(e,i),u=y(e,i);return M((function(e){}))(P(r)(d(e,o,u)))}))(w((function(e){return"query"===e.kind||"mutation"===e.kind}))(n)),i=t(w((function(e){return"query"!==e.kind&&"mutation"!==e.kind}))(n));return E([r,i])}}function oe(e){return function(e){return w((function(){return!1}))(b((function(e){}))(e))}}var ue=oe();function ae(e){return function(t){var n=t.client;return e.reduceRight((function(e,t){return t({client:n,forward:e,dispatchDebug:function(e){}})}),t.forward)}}function se(e){var t=e.onError;return function(e){var n=e.forward;return function(e){return b((function(e){var n=e.error;n&&t(n,e.operation)}))(n(e))}}}var ce=[re,Z,ie];function fe(e){return new pe(e)}function pe(e){var t=this;this.activeOperations=new Map,this.queue=[],this.createOperationContext=function(e){return e||(e={}),i({},{url:t.url,fetchOptions:t.fetchOptions,fetch:t.fetch,preferGetMethod:t.preferGetMethod},e,{suspense:e.suspense||!1!==e.suspense&&t.suspense,requestPolicy:e.requestPolicy||t.requestPolicy})},this.createRequestOperation=function(e,n,r){return V(e,n,t.createOperationContext(r))},this.executeQuery=function(e,n){var r=t.createRequestOperation("query",e,n);return t.executeRequestOperation(r)},this.executeSubscription=function(e,n){var r=t.createRequestOperation("subscription",e,n);return t.executeRequestOperation(r)},this.executeMutation=function(e,n){var r=t.createRequestOperation("mutation",e,n);return t.executeRequestOperation(r)};var n=B;this.url=e.url,this.fetchOptions=e.fetchOptions,this.fetch=e.fetch,this.suspense=!!e.suspense,this.requestPolicy=e.requestPolicy||"cache-first",this.preferGetMethod=!!e.preferGetMethod,this.maskTypename=!!e.maskTypename;var r=R(),o=r.next;this.operations$=r.source;var u=!1;this.dispatchOperation=function(e){for(u=!0,e&&o(e);e=t.queue.shift();)o(e);u=!1},this.reexecuteOperation=function(e){("mutation"===e.kind||t.activeOperations.has(e.key))&&(t.queue.push(e),u||Promise.resolve().then(t.dispatchOperation))};var a=ae(void 0!==e.exchanges?e.exchanges:ce);this.results$=x(a({client:this,dispatchDebug:n,forward:oe()})(this.operations$)),A(this.results$)}pe.prototype.executeRequestOperation=function(e){var t=this,n=this.activeOperations.get(e.key);if(!n){var r=w((function(t){return t.operation.kind===e.kind&&t.operation.key===e.key}))(this.results$);if(this.maskTypename&&(r=O((function(e){return i({},e,{data:J(e.data)})}))(r)),"mutation"===e.kind)return q(1)(D((function(){return t.dispatchOperation(e)}))(r));n={source:x(Q((function(){n.replay=null,t.activeOperations.delete(e.key);for(var r=t.queue.length-1;r>=0;r--)t.queue[r].key===e.key&&t.queue.splice(r,1);t.dispatchOperation(V("teardown",e,e.context))}))(M((function(e){n.replay=e}))(L((function(n){return n.stale?N(n):E([N(n),O((function(){return i({},n,{stale:!0})}))(q(1)(w((function(t){return t.kind===e.kind&&t.key===e.key&&("network-only"===t.context.requestPolicy||"cache-and-network"===t.context.requestPolicy)}))(t.operations$)))])}))(P(w((function(t){return"teardown"===t.kind&&t.key===e.key}))(this.operations$))(r))))),replay:null}}var o=n.replay,u=R(),a="cache-and-network"===e.context.requestPolicy||"network-only"===e.context.requestPolicy;return D((function(){if(t.activeOperations.set(e.key,n),"subscription"===e.kind)return t.dispatchOperation(e);a&&t.dispatchOperation(e),null!=o&&o===n.replay?u.next(a?i({},o,{stale:!0}):o):a||t.dispatchOperation(e)}))(E([u.source,n.source]))},pe.prototype.query=function(e,t,n){return n&&"boolean"==typeof n.suspense||(n=i({},n,{suspense:!1})),U(this.executeQuery(v(e,t),n))},pe.prototype.readQuery=function(e,t,n){var r=null;return j((function(e){r=e}))(this.query(e,t,n)).unsubscribe(),r},pe.prototype.subscription=function(e,t,n){return this.executeSubscription(v(e,t),n)},pe.prototype.mutation=function(e,t,n){return U(this.executeMutation(v(e,t),n))};export{pe as Client,Z as cacheExchange,ae as composeExchanges,fe as createClient,ne as debugExchange,re as dedupExchange,ce as defaultExchanges,se as errorExchange,ue as fallbackExchangeIO,ie as fetchExchange,G as formatDocument,K as gql,V as makeOperation,J as maskTypename,X as ssrExchange,te as subscriptionExchange};
//# sourceMappingURL=urql-core.min.mjs.map
